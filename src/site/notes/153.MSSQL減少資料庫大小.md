---
{"dg-publish":true,"permalink":"/153.MSSQLæ¸›å°‘è³‡æ–™åº«å¤§å°/","tags":["ğŸªŸ"],"created":"","updated":""}
---


# ç¡ç¡å¿µ

ä¹Ÿä¸çŸ¥é“æˆ‘æ€éº¼ä¹Ÿå…¼DBAäº†ï¼Œæœ‰ç¨®MISçš„æ„Ÿè¦ºï¼Œå•¥éƒ½ç®¡ã€‚
å¦‚æœè³‡æ–™é‡å¤ªå¤šï¼Œåˆªé™¤è³‡æ–™å¾Œï¼Œæ˜¯ä¸æœƒæŠŠç©ºé–“é‡‹æ”¾çš„ï¼Œ
éœ€è¦å°è³‡æ–™åº«åšå£“ç¸®ï¼Œå®¹é‡æ‰æœƒé‚„å‡ºä¾†ã€‚

# æ­£æ–‡

é †ä¾¿èªªä¸€ä¸‹æŸ¥å®¹é‡çš„æ­¥é©Ÿ
1. æŸ¥è³‡æ–™åº«çš„å®¹é‡
```sql
SELECT DB_NAME(database_id) N'è³‡æ–™åº«', physical_name N'å¯¦é«”æª”æ¡ˆ', type_desc N'æª”æ¡ˆé¡å‹', state_desc N'æª”æ¡ˆç‹€æ…‹', size*8.0/1024 N'æª”æ¡ˆå¤§å°(MB)'
FROM sys.master_files
```
2. æŸ¥è©¢è³‡æ–™è¡¨å¤§å°
```sql
SELECT 
    t.NAME AS TableName,
    s.Name AS SchemaName,
    p.rows,
    SUM(a.total_pages) * 8 AS TotalSpaceKB, 
    CAST(ROUND(((SUM(a.total_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS TotalSpaceMB,
    SUM(a.used_pages) * 8 AS UsedSpaceKB, 
    CAST(ROUND(((SUM(a.used_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS UsedSpaceMB, 
    (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS UnusedSpaceKB,
    CAST(ROUND(((SUM(a.total_pages) - SUM(a.used_pages)) * 8) / 1024.00, 2) AS NUMERIC(36, 2)) AS UnusedSpaceMB
FROM 
    sys.tables t
INNER JOIN
    sys.indexes i ON t.OBJECT_ID = i.object_id
INNER JOIN 
    sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id
INNER JOIN 
    sys.allocation_units a ON p.partition_id = a.container_id
LEFT OUTER JOIN 
    sys.schemas s ON t.schema_id = s.schema_id
WHERE 
    t.NAME NOT LIKE 'dt%' 
    AND t.is_ms_shipped = 0
    AND i.OBJECT_ID > 255 
GROUP BY 
    t.Name, s.Name, p.Rows
ORDER BY 
    TotalSpaceMB DESC, t.Name
```
3.  åˆªé™¤å®Œå¾Œï¼Œå¯ä»¥å…ˆåšäº¤æ˜“è¨˜éŒ„æª”å£“ç¸®
```sql
ALTER DATABASE table_name SET RECOVERY simple
use table_name
go
dbcc shrinkfile('table_name_log',2)

ALTER DATABASE table_name SET RECOVERY FULL
```
4.  å£“ç¸®DBï¼Œå°‡ç©ºé–“é‡‹æ”¾ï¼Œå¯ä»¥ç”¨æŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨SSMSæ“ä½œ
æŒ‡ä»¤ï¼Œå¯ä»¥è·Ÿstep 3 ä¸€èµ·å‹•ä½œ
```sql
1.  DBCC SHRINKDATABASE(N'Stage_db' )
```
æˆ–æ˜¯ç›´æ¥ç…§åœ–æ“ä½œ
![153-fig.1.jpg](/img/user/153-fig.1.jpg)
![153-fig.2.jpg](/img/user/153-fig.2.jpg)


ref. 
- [SQL SERVER å£“ç¸®è³‡æ–™åº«å¾ŒMDFæ²’è®Šå°](https://ithelp.ithome.com.tw/questions/10209350)
- [MsSql å£“ç¸®è³‡æ–™åº«(å«ä¿®å¾©è³‡æ–™åº«)](https://hackmd.io/@ab-5tCCfRu2OkxqJptnkGg/BJFBvHD2w)
- [[SQL]æ–¯æ–¯æœ‰ä¸‰ç¨®ï¼ŒSQL Server ä¸Šè³‡æ–™åº«çš„ã€Œå£“ç¸®ã€ä¹Ÿæœ‰ä¸‰ç¨®å–” !](https://dotblogs.com.tw/jamesfu/2014/02/23/compression)
- [DBCC SHRINKDATABASE (Transact-SQL)](https://learn.microsoft.com/zh-tw/sql/t-sql/database-console-commands/dbcc-shrinkdatabase-transact-sql?view=sql-server-ver16)
- [æ¸…é™¤SQL Server Logæª” (äº¤æ˜“ç´€éŒ„)](https://hackmd.io/@Not/H1YBRk6qw)
- [è§£æ±ºå¤§é‡è³‡æ–™åˆªé™¤ï¼Œé€ æˆè³‡æ–™åº«äº¤æ˜“ç´€éŒ„æª”æ¡ˆå®¹é‡éå¤§ä¸”è€—è²»æ™‚é–“ä¹‹è™•ç†](https://dotblogs.com.tw/jamesfu/2015/05/16/deleterecords)